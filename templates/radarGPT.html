<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProblemSniper â€“ Multi-Source Startup Radar</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <!-- Load database service first -->
  <script src="static/db-service.js"></script>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    :root {
      --side-nav-width: 80px;
      --history-width: 180px;
      --collapsed-history-width: 0px;
      --transition: 0.3s cubic-bezier(.6,-0.28,.74,.05);
    }
    html, body {
      min-height: 100%;
      background: #000;
      color: white;
      font-family: 'Poppins', 'Montserrat', sans-serif;
      overflow-x: hidden;
    }
    #star-bg-canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 1;
      pointer-events: none;
    }
    .side-nav {
      position: fixed;
      top: 0;
      left: 0;
      width: var(--side-nav-width);
      height: 100vh;
      background-color: #0b1c26;
      z-index: 20;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem 0;
      gap: 1.2rem;
      box-shadow: 2px 0 10px rgba(0,0,0,0.6);
    }
    .side-nav a {
      text-align: center;
      color: #b0faff;
      font-size: 0.7rem;
      text-decoration: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      transition: all 0.3s ease;
    }
    .side-nav a:hover {
      color: #00fff7;
      transform: scale(1.05);
    }
    .side-nav img {
      width: 20px;
      height: 20px;
      filter: brightness(0) invert(1);
    }
    .history-sidebar {
      position: fixed;
      top: 0;
      left: var(--side-nav-width);
      width: var(--history-width);
      height: 100vh;
      background: rgba(0, 255, 247, 0.07);
      box-shadow: 2px 0 14px rgba(0,255,247,0.05);
      border-right: 1.5px solid rgba(0,255,247,0.12);
      z-index: 19;
      padding: 1.2rem 0.5rem 1.2rem 0.5rem;
      overflow-y: auto;
      gap: 0;
      align-items: stretch;
      transition: width var(--transition), left var(--transition), opacity var(--transition), padding var(--transition);
    }
    .history-sidebar.collapsed {
      width: var(--collapsed-history-width);
      min-width: 0;
      padding: 0;
      opacity: 0;
      pointer-events: none;
    }
    .history-title {
      font-size: 1.1rem;
      color: #00fff7;
      margin-bottom: 1rem;
      font-weight: 700;
      text-align: left;
      padding-left: 1rem;
    }
    .history-list {
      list-style: none;
      padding: 0 0.5rem;
      margin: 0;
    }
    .history-list li {
      margin-bottom: 0.5rem;
      padding: 0.7rem 1rem;
      background: rgba(0,255,247,0.10);
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      transition: background 0.18s, color 0.18s;
      font-size: 0.98rem;
      text-align: left;
      border: 1.5px solid rgba(0,255,247,0.15);
      word-break: break-word;
      outline: none;
    }
    .history-list li.active,
    .history-list li:focus,
    .history-list li:hover {
      background: linear-gradient(90deg,#00fff7,#5e9fd4);
      color: #001f2f;
      font-weight: 700;
    }
    .history-toggle-btn {
      position: fixed;
      top: 16px;
      left: calc(var(--side-nav-width) + var(--history-width) - 16px);
      z-index: 30;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #00fff7;
      color: #001f2f;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 12px rgba(0,255,247,0.18);
      cursor: pointer;
      transition: left var(--transition), background 0.18s;
    }
    .history-sidebar.collapsed + .history-toggle-btn {
      left: calc(var(--side-nav-width) - 16px);
    }
    .history-toggle-btn svg {
      width: 18px;
      height: 18px;
      fill: #001f2f;
      transition: transform 0.25s;
    }
    .history-sidebar.collapsed ~ .history-toggle-btn svg {
      transform: rotate(180deg);
    }
    .center-main {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin-left: calc(var(--side-nav-width) + var(--history-width));
      padding-bottom: 120px;
      width: calc(100% - var(--side-nav-width) - var(--history-width));
      transition: margin-left var(--transition), width var(--transition);
    }
    .center-main.collapsed {
      margin-left: var(--side-nav-width);
      width: calc(100% - var(--side-nav-width));
    }
    .title-header {
      font-size: 2.6rem;
      letter-spacing: 2px;
      background: linear-gradient(90deg,#fff,#aaa,#fff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.15);
      margin-top: 3rem;
      margin-bottom: 2rem;
      text-align: center;
      width: 100%;
    }
    .main-content-area {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      transition: min-height 0.3s;
    }
    .mode-cards-container {
      display: flex;
      gap: 1.2rem;
      justify-content: center;
      align-items: stretch;
      margin-bottom: 1.6rem;
      margin-top: 0.8rem;
      transition: opacity 0.5s, transform 0.5s;
      flex-wrap: wrap;
      width: 100%;
    }
    .mode-card {
      background: linear-gradient(120deg,rgb(21, 21, 21) 70%, #10202b 100%);
      border-radius: 14px;
      box-shadow: 0 2px 16px rgba(7, 7, 7, 0.1), 0 0 0 1px #192d3a;
      max-width: 200px;
      min-width: 150px;
      width: 100%;
      padding: 1.1rem 1rem 1rem 1rem;
      position: relative;
      z-index: 5;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      animation: cardPop 0.7s cubic-bezier(.6,-0.28,.74,.05) 1;
      border: 1px solid #0ff;
      transition: box-shadow 0.25s;
      margin-bottom: 0.5rem;
    }
    .mode-card:hover {
      box-shadow: 0 6px 18px rgb(255, 255, 255), 0 0 0 2px rgb(0, 0, 0);
    }
    @keyframes cardPop {
      0% { opacity: 0; transform: scale(0.8) translateY(30px);}
      100% { opacity: 1; transform: scale(1) translateY(0);}
    }
    .mode-card .mode-title {
      font-size: 1rem;
      font-weight: 700;
      color: #00fff7;
      margin-bottom: 0.4rem;
      letter-spacing: 0.5px;
    }
    .mode-card .mode-desc {
      font-size: 0.93rem;
      color: #d2faff;
      margin-bottom: 0.1rem;
      line-height: 1.5;
    }
    .mode-card .mode-icon {
      font-size: 1.6rem;
      margin-bottom: 0.2rem;
      color: #00fff7;
      filter: drop-shadow(0 0 6px #00fff7);
    }
    .result-block {
      margin-bottom: 2.5rem;
      width: 100%;
      max-width: 900px;
      margin-left: 0;
      margin-right: auto;
      animation: cardPop 0.7s cubic-bezier(.6,-0.28,.74,.05) 1;
      transition: box-shadow 0.25s;
    }
    .result-block.highlight {
      box-shadow: 0 0 0 4px #00fff7, 0 2px 24px #00fff7;
      transition: box-shadow 0.25s;
      z-index: 100;
    }
    .result-query {
      font-size: 1.1rem;
      color: #5e9fd4;
      margin-bottom: 0.3em;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-align: left;
    }
    .answer-card {
      background: rgba(16,26,35,0.98);
      border-radius: 18px;
      box-shadow: 0 2px 24px rgba(0,255,247,0.10), 0 0 0 1.5px #192d3a;
      max-width: 900px;
      width: 100%;
      margin: 0 0 1.5rem 0;
      padding: 2.2rem 2rem 2rem;
      z-index: 5;
      position: relative;
      min-height: 120px;
      margin-left: 0;
      margin-right: auto;
      text-align: left;
      color: #e7faff;
    }
    .answer-card h2 {
      color: #00fff7;
      font-size: 1.3rem;
      margin-bottom: 1.1rem;
      text-align: left;
    }
    .summary-content {
      background: #101e2b;
      border-radius: 14px;
      padding: 1.2em 1.1em 1.1em 1.6em;
      margin-bottom: 1.2em;
      color: #e7faff;
      font-size: 1.04rem;
      line-height: 1.35;
      box-shadow: 0 2px 16px rgba(0,255,247,0.07), 0 0 0 1px #22384a;
      word-break: break-word;
    }
    .summary-content ul,
    .summary-content ol {
      margin: 0.4em 0 0.7em 1.1em;
      padding-left: 1.1em;
    }
    .summary-content ul { list-style-type: disc; }
    .summary-content ol { list-style-type: decimal; }
    .summary-content li {
      margin-bottom: 0.22em;
      font-size: 1.03em;
      line-height: 1.38;
      list-style-position: outside;
    }
    .summary-content li.compact {
      margin-bottom: 0;
      line-height: 1.2;
    }
    .summary-content b {
      color: #00fff7;
    }
    .summary-content h2, .summary-content h3, .summary-content h4 {
      color: #00fff7;
      margin-top: 1.1em;
      margin-bottom: 0.5em;
      font-weight: 700;
    }
    .summary-content h2 { font-size: 1.12em; }
    .summary-content h3 { font-size: 1.06em; }
    .summary-content h4 { font-size: 1.03em; }
    .related-block {
      background: rgba(24, 32, 44, 0.97);
      border-radius: 16px;
      box-shadow: 0 0 12px #00fff7, 0 0 2px #5e9fd4;
      margin: 2.5rem 0 0 0;
      padding: 1.3rem 1.5rem 1.1rem 1.5rem;
      max-width: 900px;
      width: 100%;
      color: #b0faff;
      margin-left: 0;
      margin-right: auto;
      text-align: left;
    }
    .related-block h2 {
      color: #00fff7;
      font-size: 1.1rem;
      margin-bottom: 0.8rem;
      text-align: left;
    }
    .related-list {
      margin: 0.2em 0 0 0;
      padding-left: 1.2em;
      color: #c5eaff;
      text-align: left;
      display: inline-block;
    }
    .related-list li {
      margin-bottom: 0.3em;
      font-size: 1.01em;
    }
    .related-link {
      color: #00fff7;
      text-decoration: underline;
    }
    .related-link:hover {
      color: #fff;
      text-decoration: underline;
    }
    .sources-toggle-btn {
      background: linear-gradient(90deg,#00fff7,#5e9fd4);
      color: #001f2f;
      border: none;
      border-radius: 18px;
      padding: 0.7em 1.3em;
      font-size: 1.1em;
      font-family: 'Montserrat', 'Poppins', sans-serif;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 12px rgba(0,255,247,0.18);
      transition: background 0.18s, color 0.18s, box-shadow 0.18s;
      margin-bottom: 1.2em;
      display: block;
      margin-left: 0;
      margin-right: auto;
    }
    .sources-toggle-btn:hover {
      background: linear-gradient(90deg,#5e9fd4,#00fff7);
      color: #001f2f;
      box-shadow: 0 6px 18px #00fff7;
    }
    .sources-container {
      display: none;
      margin: 0 0 1.5em 0;
      max-width: 900px;
      width: 100%;
      background: rgba(10,20,30,0.97);
      border-radius: 16px;
      box-shadow: 0 0 12px #00fff7, 0 0 2px #5e9fd4;
      padding: 1.1rem 1.5rem 1.1rem 1.5rem;
      margin-left: 0;
      margin-right: auto;
      text-align: left;
    }
    .search-section {
      position: fixed;
      left: calc(var(--side-nav-width) + var(--history-width));
      right: 0;
      bottom: 20px;
      width: auto;
      max-width: 900px;
      margin: 0 auto;
      z-index: 999;
      background: rgba(0,0,0,0.96);
      padding: 0.5rem 1rem 0.5rem 1rem;
      box-shadow: 0 -2px 16px rgba(0,255,247,0.10);
      border-radius: 18px 18px 0 0;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: left var(--transition), width var(--transition);
    }
    .search-section.collapsed {
      left: var(--side-nav-width);
      width: auto;
      max-width: 1200px;
    }
    .search-box {
      width: 100%;
      display: flex;
      align-items: flex-end;
      padding: 0.4rem 1.2rem;
      border-radius: 50px;
      background: rgba(0, 255, 247, 0.05);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(0, 255, 247, 0.2);
      box-shadow: 0 0 10px rgba(0, 255, 247, 0.15);
      transition: all 0.3s ease-in-out;
      animation: neonGlow 3s infinite alternate;
      gap: 1rem;
      position: relative;
      z-index: 998;
      flex-wrap: wrap;
      max-width: 820px;
      margin: 0 auto;
    }
    @keyframes neonGlow {
      0% { box-shadow: 0 0 10px rgba(0,255,247,0.15); }
      100% { box-shadow: 0 0 25px rgba(0,255,247,0.5); }
    }
    .dropup {
      position: relative;
      display: inline-block;
    }
    .dropup-btn {
      position: relative;
      min-width: 120px;
      user-select: none;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      color: white;
      border-radius: 30px;
      background: rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(0,255,247,0.3);
      padding: 0.2rem 1.2rem;
      box-shadow: 0 0 8px rgba(0,255,247,0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s ease;
      height: 32px;
      z-index: 1001;
    }
    .dropup-btn:after {
      content: '';
      border: 6px solid transparent;
      border-bottom-color: #00fff7;
      margin-left: 10px;
      transition: transform 0.3s ease;
      display: inline-block;
    }
    .dropup.open .dropup-btn:after {
      transform: rotate(180deg);
    }
    .dropup-menu {
      display: none;
      position: absolute;
      left: 0;
      bottom: 110%;
      min-width: 180px;
      background: rgb(0, 0, 0);
      border-radius: 18px;
      box-shadow: 0 4px 32px 0 rgba(0,255,247,0.18), 0 1.5px 8px 0 rgba(0,255,247,0.10);
      border: 1.5px solid rgba(0,255,247,0.15);
      z-index: 1002;
      padding: 0.3rem 0;
      animation: fadeInUp 0.2s;
      color: #fff;
      backdrop-filter: blur(14px);
    }
    .dropup.open .dropup-menu {
      display: block;
    }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(8px);} to { opacity: 1; transform: none; } }
    .dropup-option {
      display: flex;
      align-items: center;
      gap: 0.6em;
      padding: 0.7em 1.2em;
      background: none;
      border: none;
      color: #fff;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
      transition: background 0.15s, color 0.15s;
      outline: none;
      text-align: left;
    }
    .dropup-option.selected {
      background: linear-gradient(90deg,#00fff7,#5e9fd4);
      color:rgb(243, 243, 243);
    }
    .dropup-option:hover, .dropup-option:focus {
      background: rgba(255, 255, 255, 0.14);
      color:rgb(106, 118, 118);
    }
    .search-box textarea {
      flex: 1;
      padding: 0.4rem 1rem;
      font-size: 1.08rem;
      border: none;
      border-radius: 22px;
      outline: none;
      background: transparent;
      color: white;
      font-family: 'Poppins';
      min-width: 0;
      min-height: 32px;
      max-height: 70px;
      resize: none;
      overflow-y: hidden;
      line-height: 1.5;
      box-sizing: border-box;
      margin-right: 0.5rem;
      width: 100%;
      max-width: 100%;
    }
    .search-box textarea::placeholder {
      color: #ccc;
    }
    .send-button {
      background-color: #00fff7;
      border: none;
      border-radius: 50%;
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 8px rgba(0,255,247,0.5);
      flex-shrink: 0;
    }
    .send-button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 14px rgba(0,255,247,0.9);
    }
    .send-button svg {
      width: 20px;
      height: 20px;
      fill: black;
    }
    .new-search-btn {
      margin-left: 1.2rem;
      background: linear-gradient(90deg,#00fff7,#5e9fd4);
      color: #001f2f;
      border: none;
      border-radius: 18px;
      padding: 0.7em 1.3em;
      font-size: 1.1em;
      font-family: 'Montserrat', 'Poppins', sans-serif;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 12px rgba(0,255,247,0.18);
      transition: background 0.18s, color 0.18s, box-shadow 0.18s;
      display: flex;
      align-items: center;
      height: 38px;
      display: none;
    }

.history-list li {
  position: relative;
  /* ...existing styles... */
}

.delete-history-btn {
  display: none;
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: #ff3b3b;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  font-size: 1.1rem;
  cursor: pointer;
  z-index: 2;
  transition: background 0.18s;
  opacity: 0.85;
}
.history-list li:hover .delete-history-btn,
.history-list li:focus .delete-history-btn {
  display: block;
}
.delete-history-btn:hover {
  background: #ff0000;
  opacity: 1;
}


    .new-search-btn:hover {
      background: linear-gradient(90deg,#5e9fd4,#00fff7);
      color: #001f2f;
      box-shadow: 0 6px 18px #00fff7;
    }
    @media (max-width: 1200px) {
      .center-main { margin-left: 80px; width: calc(100% - 80px);}
      .history-sidebar, .history-toggle-btn { display: none; }
      .search-section { left: 80px; }
    }
    @media (max-width: 900px) {
      .main-content-area { max-width: 98vw; }
      .mode-cards-container { flex-direction: column; align-items: center; gap: 1.1rem;}
      .mode-card { max-width: 320px; min-width: 140px; width: 95%; }
      .result-block, .answer-card, .related-block, .sources-container { max-width: 98vw; }
    }
    @media (max-width: 700px) {
      .container { padding-left: 0; }
      .side-nav { width: 60px; }
      .side-nav a { font-size: 0.6rem; }
      .main-content-area, .search-section, .related-block, .sources-container { max-width: 100vw; }
      .answer-card, .section, .search-section, .related-block, .sources-container { max-width: 100vw; }
      .dropup-btn {
        min-width: 90px;
        font-size: 0.9rem;
      }
      .search-box { max-width: 100vw; }
      .mode-card { padding: 1rem 0.7rem 0.9rem 0.7rem; }
      .new-search-btn { font-size: 1em; padding: 0.5em 1em; }
    }

.chat-thread-container {
  max-width: 700px;
  margin: 2rem auto 0 auto;
  background: rgba(0,255,247,0.05);
  border-radius: 16px;
  box-shadow: 0 0 8px #00fff7;
  padding: 1.2rem;
}
.chat-messages {
  min-height: 80px;
  margin-bottom: 1rem;
  font-size: 1.05em;
}
.chat-message-user {
  color: #00fff7;
  margin-bottom: 0.2em;
  font-weight: 600;
}
.chat-message-bot {
  color: #5e9fd4;
  margin-bottom: 0.7em;
}
.chat-input-form {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.5rem;
}
.chat-input {
  flex: 1;
  border-radius: 12px;
  padding: 0.6rem;
  border: none;
  font-size: 1em;
  resize: none;
  background: #101e2b;
  color: #fff;

  min-height: 50px;
  max-height: 500px;
  overflow-y: auto;
  resize: none;

}
.chat-send-btn {
  background: #00fff7;
  border: none;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  color: #001f2f;
  font-size: 1.2em;
  cursor: pointer;
  transition: background 0.18s;
  box-shadow: 0 2px 8px #00fff7;
}
.chat-send-btn:hover {
  background: #5e9fd4;
}

.chat-message-bot li {
  margin-bottom: 0.3em;
  line-height: 1.3;
}
.chat-message-bot ul,
.chat-message-bot ol {
  margin-top: 0.3em;
  margin-bottom: 0.5em;
  padding-left: 1.2em;
}

/* Loading Animation Styles */
.loading-animation {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px 0;
  width: 100%;
  margin: 20px 0;
  background: none;
  border: none;
  box-shadow: none;
}

.loading-track {
  position: relative;
  width: 100%;
  height: 100px;
  background: none;
  margin-bottom: 15px;
  overflow: visible;
  border: none;
}

.loading-task {
  position: absolute;
  top: 20px;
  transform: translateY(0);
  padding: 8px 4px;
  background: rgba(0,0,0,0.7);
  border-radius: 8px;
  font-size: 12px;
  font-weight: bold;
  color: #00fff7;
  border: 1px solid rgba(0,255,247,0.3);
  transition: all 0.3s ease;
  box-shadow: 0 0 15px rgba(0,255,247,0.2);
  z-index: 2;
  width: 70px;
  text-align: center;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
}

.loading-task::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  width: 2px;
  height: 20px;
  background: rgba(0,255,247,0.3);
}

#task-1 { left: 5%; }
#task-2 { left: 33%; }
#task-3 { left: 66%; }
#task-4 { left: 95%; }

.loading-character {
  position: absolute;
  bottom: 25px;
  height: 30px;
  width: 15px;
  animation: runCharacter 12s infinite;
  z-index: 1;
}

.character-body {
  position: absolute;
  width: 12px;
  height: 20px;
  background: #00fff7;
  border-radius: 6px;
  bottom: 0;
  left: 0;
}

.character-head {
  position: absolute;
  width: 10px;
  height: 10px;
  background: #00fff7;
  border-radius: 50%;
  bottom: 20px;
  left: 1px;
}

.character-arm-left, .character-arm-right {
  position: absolute;
  width: 8px;
  height: 3px;
  background: #00fff7;
  bottom: 15px;
}

.character-arm-left {
  left: -5px;
  animation: moveLeftArm 0.5s infinite alternate;
}

.character-arm-right {
  right: -5px;
  animation: moveRightArm 0.5s infinite alternate;
}

.character-leg-left, .character-leg-right {
  position: absolute;
  width: 3px;
  height: 8px;
  background: #00fff7;
  bottom: -8px;
}

.character-leg-left {
  left: 2px;
  animation: moveLeftLeg 0.5s infinite alternate;
}

.character-leg-right {
  right: 2px;
  animation: moveRightLeg 0.5s infinite alternate;
}

.character-thought {
  position: absolute;
  top: -25px;
  left: -15px;
  background: rgba(255,255,255,0.9);
  color: #001f2f;
  padding: 3px 8px;
  border-radius: 10px;
  font-size: 12px;
  opacity: 0;
  transition: opacity 0.3s;
  white-space: nowrap;
}

.loading-progress {
  color: #5e9fd4;
  font-size: 16px;
  font-style: italic;
  animation: pulse 1.5s infinite alternate;
  margin-top: 10px;
}

@keyframes runCharacter {
  0% { left: 85px; transform: translateX(0); }
  5% { left: 85px; transform: translateX(0); }
  7% { left: 85px; transform: translateX(0); }
  20% { left: 285px; transform: translateX(0); }
  25% { left: 285px; transform: translateX(0); }
  27% { left: 285px; transform: translateX(0); }
  40% { left: 485px; transform: translateX(0); }
  45% { left: 485px; transform: translateX(0); }
  47% { left: 485px; transform: translateX(0); }
  60% { left: 685px; transform: translateX(0); }
  65% { left: 685px; transform: translateX(0); }
  67% { left: 685px; transform: translateX(0); }
  80% { left: 85px; transform: translateX(0); }
  100% { left: 85px; transform: translateX(0); }
}

@keyframes moveLeftArm {
  0% { transform: rotate(45deg) translateY(-1px); }
  100% { transform: rotate(-45deg) translateY(1px); }
}

@keyframes moveRightArm {
  0% { transform: rotate(-45deg) translateY(-1px); }
  100% { transform: rotate(45deg) translateY(1px); }
}

@keyframes moveLeftLeg {
  0% { transform: rotate(30deg) translateY(-2px); }
  100% { transform: rotate(-10deg) translateY(2px); }
}

@keyframes moveRightLeg {
  0% { transform: rotate(-10deg) translateY(2px); }
  100% { transform: rotate(30deg) translateY(-2px); }
}

@keyframes pulse {
  0% { opacity: 0.7; }
  100% { opacity: 1; }
}

/* Task highlight animations */
#task-1 {
  animation: highlightTask 8s infinite;
}

#task-2 {
  animation: highlightTask 8s infinite;
  animation-delay: 2s;
}

#task-3 {
  animation: highlightTask 8s infinite;
  animation-delay: 4s;
}

#task-4 {
  animation: highlightTask 8s infinite;
  animation-delay: 6s;
}

@keyframes highlightTask {
  0%, 20%, 100% { 
    background: rgba(0,0,0,0.7);
    box-shadow: 0 0 15px rgba(0,255,247,0.2);
  }
  5%, 15% { 
    background: rgba(0,255,247,0.2);
    box-shadow: 0 0 20px rgba(0,255,247,0.6);
  }
}


#goTopBtn, #goBottomBtn {
  position: fixed;
  right: 32px;
  width: 48px;
  height: 48px;
  border: none;
  border-radius: 50%;
  background: transparent;
  box-shadow: 0 2px 18px rgba(0,255,247,0.18);
  cursor: pointer;
  opacity: 0.75;
  z-index: 1200;
  transition: opacity 0.2s, background 0.2s, transform 0.2s;
  display: none;
  padding: 0;
}
#goTopBtn:hover, #goBottomBtn:hover {
  opacity: 1;
  background: rgba(0,255,247,0.12);
  transform: scale(1.08);
}
#goTopBtn { bottom: 150px; }
#goBottomBtn { bottom: 96px; }
#goTopBtn svg, #goBottomBtn svg {
  display: block;
  margin: auto;
}
@media (max-width: 700px) {
  #goTopBtn, #goBottomBtn { right: 12px; width: 40px; height: 40px; }
  #goTopBtn { bottom: 80px; }
  #goBottomBtn { bottom: 24px; }
}

.edit-summary-btn {
  background: none;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 22px; /* Increase overall button size */
}
.edit-summary-btn .icon {
  font-size: 1.5em; /* Make icon bigger */
}
.edit-summary-btn .label {
  font-size: 1em;
}



.save-summary-btn {
  background: none;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 22px; /* Increase overall button size */
}
.save-summary-btn .icon {
  font-size: 1.5em; /* Make icon bigger */
}
.save-summary-btn .label {
  font-size: 1em;
}

header {
  position: fixed;
  top: 0;
  right: 0;
  left: 80px; /* Leaves space for left sidebar */
  height: 50px;
  background: #0b1c26;
  z-index: 30;
  display: flex;
  justify-content: flex-end; /* Push content to the right */
  align-items: center;
  padding: 0 1rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.7);
}

header nav {
  display: flex;
  gap: 1.5rem;
}

header nav a {
  color: #b0faff;
  text-decoration: none;
  font-weight: 600;
  font-size: 1rem;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  transition: background-color 0.3s ease, color 0.3s ease;
}

header nav a:hover {
  background-color: #00fff7;
  color: #000;
}


  </style>
</head>
<body>
  <canvas id="star-bg-canvas"></canvas>

<!-- Header -->
<header>
  <nav>
    <a href="{{ url_for('home') }}">Home</a>
    {% if current_user.is_authenticated %}
      <a href="{{ url_for('logout') }}">Logout</a>
    {% else %}
      <a href="{{ url_for('login') }}">Login</a>
    {% endif %}
  </nav>
</header>

 
   <!-- Sidebar Navigation -->
   <div class="side-nav">
    <a href="{{ url_for('radargpt') }}" title="RadarGPT" class="auth-link">
      <img src="https://img.icons8.com/ios-filled/50/globe.png" alt="RadarGPT"/>
      <span>RadarGPT</span>
    </a><br>
  
    <a href="/verticals-pain-dashboard" title="Verticals" class="auth-link">
      <img src="https://img.icons8.com/ios-filled/50/building.png" alt="Verticals"/>
      <span>Verticals</span>
    </a><br>
  
    <a href="/pain-cloud-combined" title="Pain-cloud">
      <img src="https://img.icons8.com/ios-filled/50/graph.png" alt="Account"/>
      <span>Insights</span>
    </a><br>
  
    <a href="/live-trends" title="Live Trends" class="auth-link">
      <img src="https://img.icons8.com/ios-filled/50/news.png" alt="Live Trends"/>
      <span>Trends</span>
    </a><br>
  
    <a href="/saved" title="Saved">
      <img src="https://img.icons8.com/ios-filled/50/bookmark.png" alt="Account"/>
      <span>Saved</span>
    </a><br>

    <a href="/pricing" title="Saved">
      <img src="https://img.icons8.com/ios-filled/50/price-tag.png" alt="Account"/>
      <span>Pricing</span>
    </a><br>
    
    
  </div>

</div>
  <div class="history-sidebar" id="history-sidebar">
    <div class="history-title">History</div>
    <ul class="history-list" id="history-list"></ul>
  </div>
  <button class="history-toggle-btn" id="history-toggle-btn" title="Toggle History Sidebar" aria-label="Toggle History Sidebar">
    <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg>
  </button>
  <div class="center-main" id="center-main">
    <div class="title-header">RadarGPT</div>
    <div class="main-content-area" id="main-content-area">
      <div id="mode-cards" class="mode-cards-container">
        <div class="mode-card">
          <div class="mode-icon">ðŸ”®</div>
          <div class="mode-title">Future Pain Radar</div>
          <div class="mode-desc">
            Predicts future pain points and unmet needs from real user complaints and trends. Get a market radar for what's coming next.
          </div>
        </div>
        <div class="mode-card">
          <div class="mode-icon">ðŸ§ </div>
          <div class="mode-title">Unspoken Problem Miner</div>
          <div class="mode-desc">
            Surfaces hidden, emotional, or unspoken problems from replies and reviews. Get product/UX improvement ideas from what users don't say directly.
          </div>
        </div>
        <div class="mode-card">
          <div class="mode-icon">ðŸš€</div>
          <div class="mode-title">Zero to One Generator</div>
          <div class="mode-desc">
            Generates bold, radical startup ideas that solve the root problem in a new way. Useful for founders and innovators.
          </div>
        </div>
    
      </div>
      <div id="stepwise-progress" style="display:none; margin: 1.5em 0; padding: 1em; background:rgba(0,255,247,0.07); border-radius:12px; color:#00fff7; font-size:1.1em;"></div>
      <div id="results-history"></div>
    </div>
  </div>
  <div class="search-section" id="search-section">
    <div class="search-box">
      <div class="dropup" id="dropup">
        <div class="dropup-btn" id="dropup-btn" tabindex="0" aria-haspopup="listbox" aria-expanded="false" role="combobox" aria-label="Select Mode">
          Future Pain Radar
        </div>
        <div class="dropup-menu" id="dropup-menu" role="listbox" tabindex="-1">
          <button class="dropup-option selected" data-value="future_pain" type="button">Future Pain Radar</button>
          <button class="dropup-option" data-value="unspoken" type="button">Unspoken Problem Miner</button>
          <button class="dropup-option" data-value="zero_to_one" type="button">Zero to One Generator</button>
        </div>
      </div>
      <textarea placeholder="What problem are you exploring?" id="search-input" aria-label="Search input" rows="1"></textarea>
      <button class="send-button" id="send-btn" title="Search" aria-label="Search button">
        <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
      </button>
    </div>
  </div>
  <script>
    // ... (star background, markdownToHtml, dropup logic unchanged) ...
const canvas = document.getElementById('star-bg-canvas');
    const ctx = canvas.getContext('2d');
    let w = window.innerWidth, h = window.innerHeight;
    let stars = [], STAR_COUNT = 180;
    function resize() { w = window.innerWidth; h = window.innerHeight; canvas.width = w; canvas.height = h; }
    window.addEventListener('resize', resize); resize();
    function randomStar() { return { x: Math.random() * w, y: Math.random() * h, r: Math.random() * 1.2 + 0.3, dx: (Math.random() - 0.5) * 0.08, dy: (Math.random() - 0.5) * 0.08, twinkle: Math.random() * Math.PI * 2 }; }
    function createStars() { stars = []; for (let i = 0; i < STAR_COUNT; i++) stars.push(randomStar()); }
    function drawStars() { ctx.clearRect(0, 0, w, h); for (let star of stars) { star.twinkle += 0.03; let opacity = 0.6 + 0.4 * Math.sin(star.twinkle); ctx.save(); ctx.globalAlpha = opacity; ctx.beginPath(); ctx.arc(star.x, star.y, star.r, 0, 2 * Math.PI); ctx.fillStyle = "#fff"; ctx.shadowColor = "#fff"; ctx.shadowBlur = 6; ctx.fill(); ctx.restore(); star.x += star.dx; star.y += star.dy; if (star.x < 0) star.x = w; if (star.x > w) star.x = 0; if (star.y < 0) star.y = h; if (star.y > h) star.y = 0; } requestAnimationFrame(drawStars);}
    createStars(); drawStars();

    function markdownToHtml(text) {
      text = text.replace(/^\s*\*\s*/gm, '- ');
      text = text.replace(/^### (.*)$/gm, '<h3>$1</h3>');
      text = text.replace(/^## (.*)$/gm, '<h2>$1</h2>');
      text = text.replace(/^# (.*)$/gm, '<h2>$1</h2>');
      text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                 .replace(/__(.*?)__/g, '<b>$1</b>');
      text = text.replace(/(^|\n)(\d+\..+?)(?=\n[^0-9]|\n$|\n\d+\.)/gs, function(match) {
        let items = match.trim().split(/\n/).map(x => x.replace(/^\d+\.\s?/, '').trim());
        if (items.length === 1 && !/^\d+\./.test(match.trim())) return match;
        let compact = items.every(i => /^Novelty:|^Urgency:|^Feasibility:|^Emotional intensity:|^Frequency:|^Market size:|^Validation:|^Gaps:|^Existing Solutions:|^Problem:|^Idea:|^Description:/.test(i));
        return '<ol>' + items.filter(Boolean).map(i => `<li${compact ? ' class="compact"' : ''}>${i}</li>`).join('') + '</ol>\n';
      });
      text = text.replace(/(^|\n)(-\s.+?)(?=\n[^\-\n]|\n$|\n-\s)/gs, function(match) {
        let items = match.trim().split(/\n/).map(x => x.replace(/^- /, '').trim());
        if (items.length === 1 && !/^-\s/.test(match.trim())) return match;
        let compact = items.every(i => /^Novelty:|^Urgency:|^Feasibility:|^Emotional intensity:|^Frequency:|^Market size:|^Validation:|^Gaps:|^Existing Solutions:|^Problem:|^Idea:|^Description:/.test(i));
        return '<ul>' + items.filter(Boolean).map(i => `<li${compact ? ' class="compact"' : ''}>${i}</li>`).join('') + '</ul>\n';
      });
      text = text.replace(/\*/g, '');
      text = text.replace(/\n/g, '<br>');
      return text;
    }


    function markdownToHtmlForChat(text) {
  text = text.replace(/^\s*\*\s*/gm, '- ');
  text = text.replace(/^### (.*)$/gm, '<h3>$1</h3>');
  text = text.replace(/^## (.*)$/gm, '<h2>$1</h2>');
  text = text.replace(/^# (.*)$/gm, '<h2>$1</h2>');
  text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
             .replace(/__(.*?)__/g, '<b>$1</b>');

  text = text.replace(/(^|\n)(\d+\..+?)(?=\n[^0-9]|\n$|\n\d+\.)/gs, function (match) {
    let items = match.trim().split(/\n/).map(x => x.replace(/^\d+\.\s?/, '').trim());
    if (items.length === 1 && !/^\d+\./.test(match.trim())) return match;
    let compact = items.every(i => /^Novelty:|^Urgency:|^Feasibility:|^Emotional intensity:|^Frequency:|^Market size:|^Validation:|^Gaps:|^Existing Solutions:|^Problem:|^Idea:|^Description:/.test(i));
    return '<ol>' + items.filter(Boolean).map(i => `<li${compact ? ' class="compact"' : ''}>${i}</li>`).join('') + '</ol>';
  });

  text = text.replace(/(^|\n)(-\s.+?)(?=\n[^\-\n]|\n$|\n-\s)/gs, function (match) {
    let items = match.trim().split(/\n/).map(x => x.replace(/^- /, '').trim());
    if (items.length === 1 && !/^-\s/.test(match.trim())) return match;
    let compact = items.every(i => /^Novelty:|^Urgency:|^Feasibility:|^Emotional intensity:|^Frequency:|^Market size:|^Validation:|^Gaps:|^Existing Solutions:|^Problem:|^Idea:|^Description:/.test(i));
    return '<ul>' + items.filter(Boolean).map(i => `<li${compact ? ' class="compact"' : ''}>${i}</li>`).join('') + '</ul>';
  });

  text = text.replace(/\*/g, '');
  return text; // ðŸš« no .replace(/\n/g, '<br>') here!
}


    // Dropup JS logic
    let selectedValue = 'future_pain';
    const dropup = document.getElementById('dropup');
    const dropupBtn = document.getElementById('dropup-btn');
    const dropupMenu = document.getElementById('dropup-menu');
    const dropupOptions = dropupMenu.querySelectorAll('.dropup-option');

    dropupBtn.addEventListener('click', function(e) {
      dropup.classList.toggle('open');
      dropupBtn.setAttribute('aria-expanded', dropup.classList.contains('open'));
      if (dropup.classList.contains('open')) dropupMenu.focus();
    });
    dropupBtn.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowUp') {
        e.preventDefault();
        dropup.classList.toggle('open');
        dropupBtn.setAttribute('aria-expanded', dropup.classList.contains('open'));
        if (dropup.classList.contains('open')) dropupMenu.focus();
      }
    });
    dropupMenu.addEventListener('keydown', function(e) {
      const focused = document.activeElement;
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        (focused.previousElementSibling || dropupMenu.lastElementChild).focus();
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        (focused.nextElementSibling || dropupMenu.firstElementChild).focus();
      } else if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        focused.click();
      } else if (e.key === 'Escape') {
        dropup.classList.remove('open');
        dropupBtn.setAttribute('aria-expanded', false);
        dropupBtn.focus();
      }
    });
    dropupOptions.forEach(option => {
      option.addEventListener('click', function() {
        dropupOptions.forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        selectedValue = this.getAttribute('data-value');
        dropupBtn.textContent = this.textContent;
        dropup.classList.remove('open');
        dropupBtn.setAttribute('aria-expanded', false);
        dropupBtn.focus();
      });
    });
    document.addEventListener('click', function(e) {
      if (!dropup.contains(e.target)) {
        dropup.classList.remove('open');
        dropupBtn.setAttribute('aria-expanded', false);
      }
    });
    // --- Per-query history logic, persisted in IndexedDB ---
    const textarea = document.getElementById('search-input');
    const resultsHistory = document.getElementById('results-history');
    const historyList = document.getElementById('history-list');
    const modeCards = document.getElementById('mode-cards');
    const historySidebar = document.getElementById('history-sidebar');
    const historyToggleBtn = document.getElementById('history-toggle-btn');
    const centerMain = document.getElementById('center-main');
    const searchSection = document.getElementById('search-section');
    
    // Create a fallback if dbService is not available
    if (typeof dbService === 'undefined') {
      console.warn('dbService not found, creating fallback with localStorage');
      window.dbService = {
        getQueryHistory: function() {
          return Promise.resolve(JSON.parse(localStorage.getItem('radargpt_perquery_history') || '[]'));
        },
        addQueryHistory: function(entry) {
          const arr = JSON.parse(localStorage.getItem('radargpt_perquery_history') || '[]');
          arr.unshift(entry);
          localStorage.setItem('radargpt_perquery_history', JSON.stringify(arr));
          return Promise.resolve();
        },
        updateQueryHistory: function(entry) {
          const arr = JSON.parse(localStorage.getItem('radargpt_perquery_history') || '[]');
          const idx = arr.findIndex(x => x.qid === entry.qid);
          if (idx !== -1) {
            arr[idx] = entry;
            localStorage.setItem('radargpt_perquery_history', JSON.stringify(arr));
          }
          return Promise.resolve();
        },
        deleteQueryHistory: function(qid) {
          const arr = JSON.parse(localStorage.getItem('radargpt_perquery_history') || '[]');
          const filtered = arr.filter(x => x.qid !== qid);
          localStorage.setItem('radargpt_perquery_history', JSON.stringify(filtered));
          return Promise.resolve();
        }
      };
    }
    
    function getQueryHistory() {
      return dbService.getQueryHistory();
    }
    
    function addQueryHistory(entry) {
      return dbService.addQueryHistory(entry);
    }
    
    function updateQueryHistory(entry) {
      return dbService.updateQueryHistory(entry);
    }
    
    function deleteQueryHistory(qid) {
      return dbService.deleteQueryHistory(qid);
    }

    function renderHistorySidebar() {
      return getQueryHistory().then(arr => {
        historyList.innerHTML = '';
        arr.forEach(entry => {
          const li = document.createElement('li');
          li.textContent = entry.query;
          li.title = entry.query;
          li.tabIndex = 0;
          li.onclick = (e) => {
            if (e.target.classList.contains('delete-history-btn')) return;
            showQueryResult(entry.qid, entry.sourcesId, entry.query_id);
          };
          li.onkeydown = (e) => {
            if (e.key === 'Enter' || e.key === ' ') { showQueryResult(entry.qid, entry.sourcesId); }
          };
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-history-btn';
          delBtn.title = 'Delete this query';
          delBtn.innerHTML = '&times;';
          delBtn.onclick = function(e) {
            e.stopPropagation();
            deleteQueryHistory(entry.qid).then(() => {
              renderHistorySidebar();
            });
          };
          li.appendChild(delBtn);
          historyList.appendChild(li);
        });
      });
    }

    // --- Show sources toggle logic ---
    function attachSourcesToggle(uniqueId) {
      const btn = document.getElementById(`showSourcesBtn_${uniqueId}`);
      const container = document.getElementById(`sources-container_${uniqueId}`);
      if (!btn || !container) return;
      btn.onclick = function() {
        if (container.style.display === "none" || container.style.display === "") {
          container.style.display = "block";
          btn.textContent = "Hide Sources";
        } else {
          container.style.display = "none";
          btn.textContent = "Show Sources";
        }
      };
    }




function renderChatThread(query_id) {
  return `
    <div class="chat-thread-container" id="chat-thread-${query_id}">
      <div class="chat-messages" id="chat-messages-${query_id}">
        <div style="color:#888;">Loading chat...</div>
      </div>
      <form class="chat-input-form" id="chat-input-form-${query_id}" autocomplete="off">
        <textarea class="chat-input" id="chat-input-${query_id}" rows="1" placeholder="Ask a follow-up or chat..."></textarea>
        <button type="submit" class="chat-send-btn">&#9658;</button>
      </form>
    </div>
  `;
}


function attachChatHandlers(query_id) {
  const form = document.getElementById(`chat-input-form-${query_id}`);
  const input = document.getElementById(`chat-input-${query_id}`);
  const messagesDiv = document.getElementById(`chat-messages-${query_id}`);
  if (!form || !input || !messagesDiv) return;

  // First check if we have chat messages stored in the database entry
  getQueryHistory().then(arr => {
    const entry = arr.find(x => x.query_id === query_id || x.qid === query_id);
    if (entry && entry.chatMessages && entry.chatMessages.length > 0) {
      // Use stored chat messages from database
      messagesDiv.innerHTML = entry.chatMessages.length
        ? entry.chatMessages.map(msg => `<div class="chat-message-${msg.role}"><b>${msg.role === 'user' ? 'You' : 'Bot'}:</b> ${msg.role === 'bot' ? markdownToHtmlForChat(msg.text) : msg.text}</div>`).join('')
        : '<div style="color:#888;">No follow-up yet. Ask a question below!</div>';
    } else {
      // Fallback to fetching from server
      fetch(`/query_api/${query_id}`)
        .then(res => res.json())
        .then(data => {
          const messages = data.chat || [];
          messagesDiv.innerHTML = messages.length
            ? messages.map(msg => `<div class="chat-message-${msg.role}"><b>${msg.role === 'user' ? 'You' : 'Bot'}:</b> ${msg.role === 'model' ? markdownToHtmlForChat(msg.text) : msg.text}</div>`).join('')
            : '<div style="color:#888;">No follow-up yet. Ask a question below!</div>';
            
          // Store these messages in our database entry for future use
          if (messages.length > 0 && entry) {
            entry.chatMessages = messages.map(msg => ({
              role: msg.role === 'model' ? 'bot' : msg.role,
              text: msg.text
            }));
            updateQueryHistory(entry);
          }
        });
    }
  });

  form.onsubmit = async function(e) {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    messagesDiv.innerHTML += `<div class="chat-message-user"><b>You:</b> ${text}</div>`;
    // Show typing indicator
    const typingId = `typing-${Date.now()}`;
    messagesDiv.innerHTML += `<div class="chat-message-bot" id="${typingId}"><b>Bot:</b> <span class="typing-indicator">typing...</span></div>`;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    input.value = '';

    // Use Puter.js Gemini for chat
    try {
      const response = await puter.ai.chat(text, {
        model: 'google/gemini-2.0-flash-lite-001' // or any other Gemini model
      });
      const botText = response.message.content || "No response.";
      const typingDiv = document.getElementById(typingId);
      if (typingDiv) typingDiv.innerHTML = `<b>Bot:</b> ${markdownToHtmlForChat(botText)}`;

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      // Store this conversation in our database entry
      getQueryHistory().then(arr => {
        const idx = arr.findIndex(x => x.query_id === query_id || x.qid === query_id);
        if (idx !== -1) {
          const entry = arr[idx];
          if (!entry.chatMessages) entry.chatMessages = [];
          entry.chatMessages.push(
            { role: 'user', text: text },
            { role: 'bot', text: botText }
          );
          updateQueryHistory(entry);
        }
      });
    } catch (err) {
      const typingDiv = document.getElementById(typingId);
      if (typingDiv) typingDiv.innerHTML = `<b>Bot:</b> Error: ${err}`;
    }
  };

  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      form.dispatchEvent(new Event('submit'));
    }
  });
}


    // Show the clicked query result (with sources toggle) in the main area and scroll to its top
   function showQueryResult(qid, sourcesId, query_id) {
  getQueryHistory().then(arr => {
    const q = arr.find(x => x.qid === qid);
    if (q) {
      // Rebuild the HTML with the latest summary content
      if (q.summary) {
        // Extract the summary div pattern from the HTML
        const summaryMatch = q.html.match(/(<div class="summary-content"[^>]*id="summary-[^"]+"[^>]*>)[\s\S]*?(<\/div>)/);
        if (summaryMatch) {
          // Replace the summary content with the latest version
          q.html = q.html.replace(
            /(<div class="summary-content"[^>]*id="summary-[^"]+"[^>]*>)[\s\S]*?(<\/div>)/,
            `$1${q.summary}$2`
          );
        }
      }
      // Restore result HTML (includes the Show Sources button and container already)
      resultsHistory.innerHTML = q.html;
      attachEditSaveHandlers(query_id);

      // Attach the toggle logic to the restored button
      attachSourcesToggle(sourcesId);

      // Inject chat if missing
      const chatContainer = document.getElementById(`chat-thread-${query_id}`);
      if (!chatContainer) {
        const chatHtml = renderChatThread(query_id);
        resultsHistory.insertAdjacentHTML('beforeend', chatHtml);
      }

      setTimeout(() => {
        attachChatHandlers(query_id);

        const el = document.getElementById(qid);
        if (el) {
          el.classList.add('highlight');
          const rect = el.getBoundingClientRect();
          window.scrollTo({ top: window.scrollY + rect.top, behavior: "smooth" });
          setTimeout(() => el.classList.remove('highlight'), 1200);
        }
      }, 0);
    }
  });
}
    function hideModeCards() {
      if (modeCards) modeCards.style.display = 'none';
    }

    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 70) + 'px';
    });

    document.getElementById('send-btn').addEventListener('click', function() {
      const query = textarea.value.trim();
      if (!query) return;
      hideModeCards();
      const uniqueId = 'result_' + Date.now() + '_' + Math.floor(Math.random()*10000);
      const sourcesId = uniqueId; // Use same id for sources toggle
      const loadingHtml = `
        <div class="result-block" id="${uniqueId}" style="background: none; box-shadow: none; border: none;">
          <div class="result-query">Query: <b>${query}</b></div>
          <div class="loading-track" style="width: 100%; max-width: 800px; margin: 0 auto; position: relative; height: 120px;">
            <div class="loading-task" id="task-1" style="left: 50px; width: 70px; text-align: center; position: absolute;">Search</div>
            <div class="loading-task" id="task-2" style="left: 250px; width: 70px; text-align: center; position: absolute;">Analyze</div>
            <div class="loading-task" id="task-3" style="left: 450px; width: 70px; text-align: center; position: absolute;">Think</div>
            <div class="loading-task" id="task-4" style="left: 650px; width: 70px; text-align: center; position: absolute;">Write</div>
            <div class="loading-character" style="height: 40px; width: 20px;">
              <div class="character-body" style="height: 25px; width: 15px;"></div>
              <div class="character-head" style="height: 12px; width: 12px; bottom: 25px;"></div>
              <div class="character-arm-left" style="height: 4px; width: 10px; bottom: 18px; left: -6px;"></div>
              <div class="character-arm-right" style="height: 4px; width: 10px; bottom: 18px; right: -6px;"></div>
              <div class="character-leg-left" style="height: 10px; width: 4px; bottom: -10px; left: 3px;"></div>
              <div class="character-leg-right" style="height: 10px; width: 4px; bottom: -10px; right: 3px;"></div>
              <div class="character-thought">Hmm...</div>
            </div>
          </div>
          <div class="loading-progress" id="loading-progress-${uniqueId}">Working on your request...</div>
          <div class="loading-status" id="loading-status-${uniqueId}" style="color:#5e9fd4;font-size:14px;margin-top:5px;text-align:center;"></div>
        </div>
      `;
      resultsHistory.innerHTML = loadingHtml;
      
      // Animate the character's thought bubble based on current task
      setTimeout(() => {
        const thoughtBubble = document.querySelector('.character-thought');
        if (thoughtBubble) {
          const thoughts = [
            "Finding data...", 
            "Processing...", 
            "Connecting ideas...", 
            "Finalizing..."
          ];
          
          let currentTask = 0;
          setInterval(() => {
            thoughtBubble.textContent = thoughts[currentTask % 4];
            thoughtBubble.style.opacity = 1;
            setTimeout(() => {
              thoughtBubble.style.opacity = 0;
            }, 2000);
            currentTask++;
          }, 3000);
        }
      }, 100);

      // Set up polling for progress updates
      const statusElement = document.getElementById(`loading-status-${uniqueId}`);
      
      // Start polling for status updates
      let statusCheckInterval = setInterval(() => {
        fetch(`/status_check?keyword=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(data => {
            if (data.status) {
              statusElement.innerHTML = data.status;
            }
          })
          .catch(err => console.error("Status check error:", err));
      }, 1000);
      
      fetch('/multi_search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ keyword: query, mode: selectedValue })
      })
      .then(res => res.json())
     .then(data => {
  // Stop polling for status updates
  clearInterval(statusCheckInterval);
  
  // Map complaintsboard to ComplaintsBoard for frontend display
  if (data.sources && data.sources['complaintsboard']) {
    data.sources['ComplaintsBoard'] = data.sources['complaintsboard'];
  }
  const query_id = data.query_id;
  let html = '';

 if (data.summary) {
  html += `
    <div class="answer-card">
  <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap; margin-bottom: 0.8rem;">
  <h2 style="margin: 0; font-size: 1.5rem;">Combined Summary with Citations</h2>

  <button class="save-to-saved-btn" 
          id="save-to-saved-btn-${query_id}" 
          title="Save to Saved Results"
          style="background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:16px;color:#00fff7;">
    <span style="font-size: 1.2em;">ðŸ”–</span>
    <span style="font-size: 0.95em; font-family: 'Poppins', 'Montserrat', sans-serif; color: #00fff7;">Save to Stacks</span>
  </button>
</div>


  <div class="summary-edit-row" style="display:flex;align-items:flex-start;gap:8px;">
    <div class="summary-content" 
         id="summary-${query_id}" 
         contenteditable="false" 
         spellcheck="true" 
         style="outline:2px solid transparent;transition:outline 0.2s;flex:1;">
      ${markdownToHtml(data.summary)}
    </div>
    




    <button class="edit-summary-btn" 
                id="edit-summary-btn-${query_id}" 
                title="Edit"
          <span style="font-size: 0.8em;">âœï¸</span>
          <span style="font-size: 0.2em; color: #fff;">Edit</span>
        </button>

        <!-- ðŸ’¾ Save Button -->
        <button class="save-summary-btn" 
                id="save-summary-btn-${query_id}" 
                title="Save"
          <span style="font-size: 0.8em;">ðŸ’¾</span>
          <span style="font-size: 0.2em; color: #fff;">Save</span>
        </button>

      </div>
    </div>
  `;
} else {
  html += "<div class='answer-card'><i>No summary available.</i></div>";
}



  let sourcesHtml = '';
  if (data.sources) {
    for (let source of ["Reddit", "Stack Overflow", "ComplaintsBoard", "Product Hunt", "Quora"]) {
      let posts = data.sources[source] || [];
      sourcesHtml += `<div class="section source-block"><h2>${source}</h2>`;
      if (posts.length > 0) {
        posts.forEach((post, i) => {
          sourcesHtml += `<div><span class="post-title">${i+1}. ${post.title}</span><br>`;
          if (post.url) {
            sourcesHtml += `<a class="post-link" href="${post.url}" target="_blank">${post.url}</a><br>`;
          }
          if (post.text) {
            sourcesHtml += `<div class="post-text">${post.text.replace(/\n/g, "<br>")}</div>`;
          }
          sourcesHtml += `</div>`;
        });
      } else {
        sourcesHtml += "<i>No results.</i>";
      }
      sourcesHtml += "</div>";
    }
  }

  resultsHistory.innerHTML = `
    <div class="result-block" id="${uniqueId}">
      <div class="result-query">Query: <b>${query}</b></div>
      ${html}
      <button class="sources-toggle-btn" id="showSourcesBtn_${sourcesId}">Show Sources</button>
      <div class="sources-container" id="sources-container_${sourcesId}" style="display:none;">${sourcesHtml}</div>
    </div>
    ${renderChatThread(query_id)}
  `;

  attachSourcesToggle(sourcesId);
  attachChatHandlers(query_id);

  enableSummaryEditing();

  addQueryHistory({
    qid: uniqueId,
    query_id: query_id,
    query,
    summary: markdownToHtml(data.summary),
    html: document.getElementById(uniqueId).outerHTML,
    sourcesId,
    sourcesHtml,
    timestamp: new Date().toISOString(),
    chatMessages: [] // Initialize empty chat messages array
  }).then(() => {
    renderHistorySidebar();
  });
})

      .catch(err => {
        resultsHistory.innerHTML = "<div class='answer-card'>Error: " + err + "</div>";
      });
    });

    textarea.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('send-btn').click();
      }
    });

    historyToggleBtn.addEventListener('click', function() {
      historySidebar.classList.toggle('collapsed');
      centerMain.classList.toggle('collapsed');
      searchSection.classList.toggle('collapsed');
    });

    // Initialize the history sidebar when the page loads
    renderHistorySidebar().then(() => {
      resultsHistory.innerHTML = '';
    });


    function attachEditSaveHandlers(query_id) {
  const editBtn = document.getElementById(`edit-summary-btn-${query_id}`);
  const saveBtn = document.getElementById(`save-summary-btn-${query_id}`);
  const saveToSavedBtn = document.getElementById(`save-to-saved-btn-${query_id}`);
  const summaryDiv = document.getElementById(`summary-${query_id}`);

  if (!editBtn || !saveBtn || !summaryDiv) return;

  // âœï¸ Edit Button
  editBtn.onclick = function () {
    summaryDiv.contentEditable = "true";
    summaryDiv.style.outline = "2px solid #00fff7";
    summaryDiv.focus();
  };

  // ðŸ’¾ Save Button
  saveBtn.onclick = function () {
    summaryDiv.contentEditable = "false";
    summaryDiv.style.outline = "2px solid transparent";

    getQueryHistory().then(arr => {
      const idx = arr.findIndex(x => x.query_id === query_id || x.qid === query_id);
      if (idx !== -1) {
        const entry = arr[idx];
        // Store the edited content separately for reliable retrieval
        entry.summary = summaryDiv.innerHTML;
        
        // Also update the HTML for backward compatibility
        entry.html = entry.html.replace(
          /(<div class="summary-content"[^>]*id="summary-[^"]+"[^>]*>)[\s\S]*?(<\/div>)/,
          `$1${summaryDiv.innerHTML}$2`
        );
        
        // Update the result block in the current view to reflect changes
        const resultBlock = summaryDiv.closest('.result-block');
        if (resultBlock) {
          entry.html = resultBlock.outerHTML;
        }
        
        updateQueryHistory(entry);
      }
    });
  };

  // ðŸ”– Save to Stacks
 if (saveToSavedBtn) {
  saveToSavedBtn.onclick = function () {
    const summaryHTML = summaryDiv.innerHTML;

    getQueryHistory().then(arr => {
      const idx = arr.findIndex(x => x.query_id === query_id || x.qid === query_id);
      const sourcesHtml = idx !== -1 ? arr[idx].sourcesHtml || '' : '';
      const queryText = idx !== -1 ? arr[idx].query || `Saved Summary (${new Date().toLocaleString()})` : `Saved Summary (${new Date().toLocaleString()})`;

      // Always show collection selection dialog
      showCollectionDropdown(saveToSavedBtn, (collection) => {
        // Custom save function that doesn't disable the button
        let saved = JSON.parse(localStorage.getItem('radargpt_saved_queries') || '{}');
        if (!saved[collection]) saved[collection] = [];
        
        // Add new item with size limits
        saved[collection].unshift({
          id: 'saved_' + Date.now(),
          query: queryText,
          html: summaryHTML.substring(0, 10000), // Limit size
          sourcesHtml: sourcesHtml ? sourcesHtml.substring(0, 5000) : '' // Limit size
        });
        
        // Save back to localStorage
        localStorage.setItem('radargpt_saved_queries', JSON.stringify(saved));
        
        // Show brief confirmation without disabling the button
        const originalText = saveToSavedBtn.querySelector('span:last-child').textContent;
        saveToSavedBtn.querySelector('span:last-child').textContent = 'Saved to ' + collection;
        
        setTimeout(() => {
          saveToSavedBtn.querySelector('span:last-child').textContent = originalText;
        }, 2000);

        summaryDiv.contentEditable = "false";
        summaryDiv.style.outline = "2px solid transparent";

        if (idx !== -1) {
          const entry = arr[idx];
          // Store the edited content separately for reliable retrieval
          entry.summary = summaryHTML;

          // Also update the HTML for backward compatibility
          entry.html = entry.html.replace(
            /(<div class="summary-content"[^>]*id="summary-[^"]+"[^>]*>)[\s\S]*?(<\/div>)/,
            `$1${summaryHTML}$2`
          );

          // Update the result block in the current view to reflect changes
          const resultBlock = summaryDiv.closest('.result-block');
          if (resultBlock) {
            entry.html = resultBlock.outerHTML;
          }

          updateQueryHistory(entry);
        }
      }, { query: queryText });
    });
  };
}



  // Optional: pressing Enter+Ctrl/Meta saves too
  summaryDiv.addEventListener('keydown', function (e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      saveBtn.click();
    }
  });
}




function enableSummaryEditing() {
  document.querySelectorAll('.answer-card').forEach(card => {
    const summaryDiv = card.querySelector('.summary-content');
    const editBtn = card.querySelector('.edit-summary-btn');
    const saveBtn = card.querySelector('.save-summary-btn');

    if (!summaryDiv || !editBtn || !saveBtn) return;

    editBtn.onclick = function() {
      summaryDiv.contentEditable = "true";
      summaryDiv.focus();
      summaryDiv.style.outline = '2px solid #00fff7';
      editBtn.style.display = "none";
      saveBtn.style.display = "inline-block";
    };

    saveBtn.onclick = function() {
      summaryDiv.contentEditable = "false";
      summaryDiv.style.outline = '2px solid transparent';
      editBtn.style.display = "inline-block";
      saveBtn.style.display = "none";
      // Optionally, save summaryDiv.innerHTML to backend/localStorage here
    };

    // Optional: pressing Enter+Ctrl/Meta saves too
    summaryDiv.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        saveBtn.click();
      }
    });
  });
}


// Helper: Get selected text within a specific container
// --- Floating Ask Bot Button Logic ---
// --- Floating Ask Bot Button Logic ---
let askBotBtn = null;

function removeAskBotBtn() {
  if (askBotBtn && askBotBtn.parentNode) {
    askBotBtn.parentNode.removeChild(askBotBtn);
    askBotBtn = null;
  }
}

// Listen for selection inside .summary-content
document.addEventListener('mouseup', function(e) {
  setTimeout(() => { // Wait for selection to update
    removeAskBotBtn();
    const selection = window.getSelection();
    const selectedText = selection && selection.toString().trim();
    if (!selectedText) return;

    // Only show if selection is inside a .summary-content
    let anchorNode = selection.anchorNode;
    let summary = anchorNode ? (anchorNode.nodeType === 1 ? anchorNode : anchorNode.parentElement).closest('.summary-content') : null;
    if (!summary) return;

    // Get the bounding rect of the selection
    let range = selection.getRangeAt(0);
    let rect = range.getBoundingClientRect();

    askBotBtn = document.createElement('button');
    askBotBtn.textContent = 'Ask the bot';
    askBotBtn.style.position = 'fixed';
    askBotBtn.style.top = (rect.bottom + 8) + 'px';
    askBotBtn.style.left = (rect.left) + 'px';
    askBotBtn.style.zIndex = 9999;
    askBotBtn.style.background = '#00fff7';
    askBotBtn.style.color = '#001f2f';
    askBotBtn.style.border = 'none';
    askBotBtn.style.borderRadius = '16px';
    askBotBtn.style.padding = '0.4em 1em';
    askBotBtn.style.boxShadow = '0 2px 8px #00fff7';
    askBotBtn.style.cursor = 'pointer';
    askBotBtn.style.fontWeight = 'bold';

    askBotBtn.onclick = function() {
      // Find the closest .result-block and its chat input
      let resultBlock = summary.closest('.result-block');
      let chatInput = null;
      let chatContainer = null;
      if (resultBlock) {
        // Find the chat-thread-container after this result block
        let next = resultBlock.nextElementSibling;
        while (next && !next.classList.contains('chat-thread-container')) {
          next = next.nextElementSibling;
        }
        if (next) {
          chatContainer = next;
          chatInput = next.querySelector('.chat-input');
        }
      }
      // Fallback: any visible chat input
      if (!chatInput) chatInput = document.querySelector('.chat-input');
      if (!chatContainer && chatInput) chatContainer = chatInput.closest('.chat-thread-container');

      if (chatInput) {
        chatInput.value = selectedText;
        chatInput.focus();
        // Scroll to chat container if found
        if (chatContainer) {
          chatContainer.scrollIntoView({ behavior: "smooth", block: "center" });
        } else {
          chatInput.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }
      removeAskBotBtn();
      window.getSelection().removeAllRanges(); // Optionally clear selection
    };

    document.body.appendChild(askBotBtn);
  }, 0);
});

// Remove the button if user clicks elsewhere or presses Escape
document.addEventListener('mousedown', function(e) {
  if (askBotBtn && !askBotBtn.contains(e.target)) {
    removeAskBotBtn();
  }
});
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') removeAskBotBtn();
});

document.querySelectorAll('.chat-input').forEach(textarea => {
  textarea.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 500) + 'px'; // Match your max-height
  });
});

// Auto-expand chat input textareas as you type
function enableAutoExpandChatInputs() {
  document.querySelectorAll('.chat-input').forEach(textarea => {
    if (!textarea.dataset.autoexpand) {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });
      textarea.dataset.autoexpand = "true";
    }
  });
}

// Call once on page load
enableAutoExpandChatInputs();

// If you dynamically create chat inputs, call enableAutoExpandChatInputs() after inserting them
// For example, after you call attachChatHandlers(query_id):
// enableAutoExpandChatInputs();


  </script>

  <!-- Go to Top/Bottom Buttons -->
<!-- Go to Top/Bottom Buttons with SVG Icons -->
<button id="goTopBtn" title="Go to Top" aria-label="Go to Top">
  <!-- Up arrow SVG -->
  <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
    <circle cx="12" cy="12" r="12" fill="#00fff7" opacity="0.15"/>
    <path d="M12 7l-5 5h3v5h4v-5h3l-5-5z" fill="#00fff7"/>
  </svg>
</button>
<button id="goBottomBtn" title="Go to Bottom" aria-label="Go to Bottom">
  <!-- Down arrow SVG -->
  <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
    <circle cx="12" cy="12" r="12" fill="#00fff7" opacity="0.15"/>
    <path d="M12 17l5-5h-3v-5h-4v5h-3l5 5z" fill="#00fff7"/>
  </svg>
</button>



<script>
const goTopBtn = document.getElementById('goTopBtn');
const goBottomBtn = document.getElementById('goBottomBtn');

function updateScrollBtns() {
  const scrollY = window.scrollY || window.pageYOffset;
  const winH = window.innerHeight;
  const docH = document.documentElement.scrollHeight;
  goTopBtn.style.display = scrollY > 100 ? 'block' : 'none';
  goBottomBtn.style.display = (scrollY + winH < docH - 100) ? 'block' : 'none';
}

goTopBtn.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});
goBottomBtn.addEventListener('click', () => {
  window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
});

window.addEventListener('scroll', updateScrollBtns);
window.addEventListener('resize', updateScrollBtns);
document.addEventListener('DOMContentLoaded', updateScrollBtns);
</script>
<script src="static/save-to-stacks.js"></script>
<script src="static/radargpt-save-module.js"></script>

<script>
// ... existing code ...
// --- CLEAN RADARGPT PROGRESS LOGIC ---
let selectedValue = 'future_pain';
const textarea = document.getElementById('search-input');
const resultsHistory = document.getElementById('results-history');
const sendBtn = document.getElementById('send-btn');
const stepwiseProgress = document.getElementById('stepwise-progress');

sendBtn.onclick = async function() {
  const query = textarea.value.trim();
  if (!query) return;
  stepwiseProgress.style.display = 'block';
  stepwiseProgress.innerHTML = '<b>Thinking...</b>';
  resultsHistory.innerHTML = '';
  let mode = selectedValue || 'future_pain';
  let steps = [];
  let finalResult = null;

  // Use fetch with ReadableStream for POST streaming
  const resp = await fetch('/radargpt-steps', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({keyword: query, mode})
  });

  if (!resp.body) {
    stepwiseProgress.innerHTML = '<b>Error: Streaming not supported in this browser.</b>';
    return;
  }

  const reader = resp.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, {stream: true});
    let parts = buffer.split('\n\n');
    buffer = parts.pop(); // last part may be incomplete
    for (let part of parts) {
      if (part.startsWith('data:')) {
        let data = part.replace(/^data:\s*/, '');
        if (data.startsWith('FINAL_ANSWER::')) {
          finalResult = JSON.parse(data.replace('FINAL_ANSWER::',''));
          stepwiseProgress.style.display = 'none';
          resultsHistory.innerHTML = `<div class='answer-card'>${finalResult.summary}</div>`;
        } else if (data.startsWith('Error:')) {
          stepwiseProgress.innerHTML += `<div style='color:#ff3b3b;'>${data}</div>`;
        } else {
          steps.push(data);
          stepwiseProgress.innerHTML = steps.map(s => `<div>${s}</div>`).join('');
        }
      }
    }
  }
};
// ... existing code ...
</script>

</body>
</html>
